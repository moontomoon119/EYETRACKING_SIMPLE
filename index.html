<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì•„ì´íŠ¸ë˜í‚¹ ë°ì´í„° ë·°ì–´</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            color: #333;
            height: 100vh;
            overflow: hidden;
        }

        .container {
            display: flex;
            height: 100vh;
        }

        .sidebar {
            width: 300px;
            background-color: #e8e8e8;
            border-right: 2px solid #ccc;
            padding: 20px;
            overflow-y: auto;
        }

        .sidebar h3 {
            margin-bottom: 15px;
            color: #555;
            font-size: 16px;
        }

        .upload-section {
            margin-bottom: 30px;
        }

        .file-input {
            width: 100%;
            padding: 10px;
            border: 2px dashed #999;
            border-radius: 5px;
            background-color: #fff;
            cursor: pointer;
            text-align: center;
            transition: border-color 0.3s;
        }

        .file-input:hover {
            border-color: #666;
        }

        .stimulus-list {
            margin-top: 20px;
        }

        .stimulus-item {
            background-color: #fff;
            border: 1px solid #ddd;
            padding: 12px;
            margin-bottom: 8px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .stimulus-item:hover {
            background-color: #f0f0f0;
            border-color: #999;
        }

        .stimulus-item.active {
            background-color: #4CAF50;
            color: white;
            border-color: #45a049;
        }

        .stimulus-id {
            font-weight: bold;
            font-size: 14px;
        }

        .stimulus-info {
            font-size: 12px;
            color: #666;
            margin-top: 4px;
        }

        .stimulus-item.active .stimulus-info {
            color: #e8f5e8;
        }

        .workspace {
            flex: 1;
            background-color: #fff;
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .workspace-content {
            position: relative;
            width: 1920px;
            height: 1080px;
            border: 3px solid #333;
            background-color: #fafafa;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.2);
        }

        .workspace-content::before {
            content: '1920 Ã— 1080';
            position: absolute;
            top: -35px;
            left: 0;
            background-color: #333;
            color: white;
            padding: 5px 10px;
            font-size: 12px;
            font-weight: bold;
            border-radius: 3px;
            z-index: 5;
        }

        .background-image {
            position: absolute;
            top: 50%;
            left: 50%;
            transform-origin: center;
            object-fit: contain;
            z-index: 1;
            cursor: move;
            user-select: none;
            transition: transform 0.1s ease-out;
        }

        .image-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        .image-container:hover {
            outline: 2px dashed #2196F3;
            outline-offset: 2px;
        }

        .scale-info {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: rgba(33, 150, 243, 0.9);
            color: white;
            padding: 5px 8px;
            border-radius: 3px;
            font-size: 11px;
            font-weight: bold;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 20;
            pointer-events: none;
        }

        .image-container:hover .scale-info {
            opacity: 1;
        }

        .gaze-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
            pointer-events: none;
        }

        .workspace-controls {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(255, 255, 255, 0.95);
            padding: 15px;
            border-radius: 8px;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border: 1px solid #ddd;
        }

        .background-upload {
            margin-bottom: 15px;
            text-align: center;
        }

        .image-controls {
            display: flex;
            gap: 8px;
            justify-content: center;
        }

        .control-btn {
            padding: 8px 12px;
            border: 1px solid #ccc;
            background-color: #fff;
            cursor: pointer;
            border-radius: 4px;
            font-size: 12px;
            transition: all 0.2s;
        }

        .control-btn:hover {
            background-color: #f0f0f0;
            border-color: #999;
        }

        .control-btn:active {
            background-color: #e0e0e0;
        }

        .right-sidebar {
            width: 300px;
            background-color: #e8e8e8;
            border-left: 2px solid #ccc;
            padding: 20px;
            overflow-y: auto;
        }

        .info-section {
            background-color: #fff;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 15px;
        }

        .info-label {
            font-weight: bold;
            color: #555;
            margin-bottom: 5px;
        }

        .info-value {
            color: #333;
            margin-bottom: 10px;
        }

        .loading {
            text-align: center;
            color: #666;
            padding: 20px;
        }

        .error {
            color: #d32f2f;
            background-color: #ffebee;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ì¢Œì¸¡ ì‚¬ì´ë“œë°” -->
        <div class="sidebar">
            <h3>CSV ì—…ë¡œë“œ</h3>
            <div class="upload-section">
                <input type="file" id="csvFile" accept=".csv" style="display: none;">
                <div class="file-input" onclick="document.getElementById('csvFile').click()">
                    CSV íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”
                </div>
                <div id="uploadStatus"></div>
            </div>

            <h3>Stimulus ID ëª©ë¡</h3>
            <div class="stimulus-list" id="stimulusList">
                <div class="loading">CSV íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì„¸ìš”</div>
            </div>
        </div>

        <!-- ì¤‘ì•™ ì›Œí¬ìŠ¤í˜ì´ìŠ¤ -->
        <div class="workspace">
            <div class="workspace-content" id="workspaceContent">
                <div class="image-container" id="imageContainer">
                    <div class="scale-info" id="scaleInfo">100%</div>
                </div>
                <canvas class="gaze-canvas" id="gazeCanvas" width="1920" height="1080"></canvas>
                
                <div class="workspace-controls">
                    <div class="background-upload">
                        <input type="file" id="backgroundFile" accept=".png,.jpg,.jpeg" style="display: none;">
                        <button class="control-btn" onclick="document.getElementById('backgroundFile').click()">
                            ğŸ“ ë°°ê²½ ì´ë¯¸ì§€ ì—…ë¡œë“œ
                        </button>
                    </div>
                    <div class="image-controls">
                        <button class="control-btn" onclick="resetImageTransform()">ğŸ”„ ì´ë¯¸ì§€ ë¦¬ì…‹</button>
                        <button class="control-btn" onclick="removeBackgroundImage()">ğŸ—‘ï¸ ì´ë¯¸ì§€ ì œê±°</button>
                    </div>
                    <div style="text-align: center; margin-top: 10px; font-size: 11px; color: #666;">
                        íŒ: ë§ˆìš°ìŠ¤ íœ ë¡œ í™•ëŒ€/ì¶•ì†Œ<br>
                        Ctrl + íœ : 1% ë‹¨ìœ„ ì„¸ë°€ ì¡°ì ˆ
                    </div>
                </div>
            </div>
        </div>

        <!-- ìš°ì¸¡ ì‚¬ì´ë“œë°” -->
        <div class="right-sidebar">
            <h3>ì„ íƒëœ Stimulus ì •ë³´</h3>
            <div id="stimulusInfo">
                <div class="loading">Stimulus IDë¥¼ ì„ íƒí•˜ì„¸ìš”</div>
            </div>
        </div>
    </div>

    <script>
        let csvData = [];
        let stimulusGroups = {};
        let currentStimulus = null;
        let backgroundImages = {};
        let isDragging = false;
        let isResizing = false;
        let dragStart = { x: 0, y: 0 };
        let imageTransforms = {}; // stimulusë³„ ì´ë¯¸ì§€ ë³€í™˜ ì •ë³´ ì €ì¥

        // CSV íŒŒì¼ ì—…ë¡œë“œ ì²˜ë¦¬
        document.getElementById('csvFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        parseCSV(e.target.result);
                    } catch (error) {
                        showError('CSV íŒŒì‹± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                    }
                };
                reader.readAsText(file);
            }
        });

        // ë°°ê²½ ì´ë¯¸ì§€ ì—…ë¡œë“œ ì²˜ë¦¬
        document.getElementById('backgroundFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file && currentStimulus) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    setBackgroundImage(currentStimulus, e.target.result);
                };
                reader.readAsDataURL(file);
            }
        });

        function sanitizeId(value) {
            if (!value || value === 'undefined' || value === 'null') return '';
            let text = String(value).trim();
            text = text.replace(/^["]+|["]+$/g, '');
            return text;
        }

        function parseCSV(csvText) {
            const lines = csvText.split('\n');
            if (lines.length < 2) {
                showError('CSV íŒŒì¼ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                return;
            }

            const headers = lines[0].split(',').map(h => h.trim());
            csvData = [];

            // í•„ìš”í•œ ì»¬ëŸ¼ ì¸ë±ìŠ¤ ì°¾ê¸°
            const colIndices = {
                timestamp: headers.indexOf('TimeStamp [us]'),
                type: headers.indexOf('Type'),
                stimulusId: headers.indexOf('Stimulus ID'),
                resX: headers.indexOf('Resolution X'),
                resY: headers.indexOf('Resolution Y'),
                key: headers.indexOf('Key'),
                value: headers.indexOf('Value'),
                filteredX: headers.indexOf('Filtered POR X'),
                filteredY: headers.indexOf('Filtered POR Y'),
                rawX: headers.indexOf('Raw POR X'),
                rawY: headers.indexOf('Raw POR Y')
            };

            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;

                const cols = line.split(',');
                if (cols.length < headers.length) continue;

                const row = {
                    timestamp: parseFloat(cols[colIndices.timestamp]) || 0,
                    type: sanitizeId(cols[colIndices.type]).toLowerCase(),
                    stimulusId: sanitizeId(cols[colIndices.stimulusId]),
                    resX: parseFloat(cols[colIndices.resX]) || 1920,
                    resY: parseFloat(cols[colIndices.resY]) || 1080,
                    key: sanitizeId(cols[colIndices.key]),
                    value: sanitizeId(cols[colIndices.value]),
                    filteredX: parseFloat(cols[colIndices.filteredX]),
                    filteredY: parseFloat(cols[colIndices.filteredY]),
                    rawX: parseFloat(cols[colIndices.rawX]),
                    rawY: parseFloat(cols[colIndices.rawY])
                };

                if (row.stimulusId) {
                    csvData.push(row);
                }
            }

            processData();
            document.getElementById('uploadStatus').innerHTML = 
                `<div style="color: green; margin-top: 10px;">âœ“ ${csvData.length}ê°œ í–‰ ë¡œë“œë¨</div>`;
        }

        function processData() {
            stimulusGroups = {};

            // Stimulus IDë³„ë¡œ ê·¸ë£¹í™”
            csvData.forEach(row => {
                if (!stimulusGroups[row.stimulusId]) {
                    stimulusGroups[row.stimulusId] = {
                        id: row.stimulusId,
                        data: [],
                        events: [],
                        minTimestamp: Infinity,
                        maxTimestamp: -Infinity
                    };
                }

                const group = stimulusGroups[row.stimulusId];
                
                if (row.type === 'data') {
                    group.data.push(row);
                } else if (row.type === 'event') {
                    group.events.push(row);
                }

                if (row.timestamp < group.minTimestamp) group.minTimestamp = row.timestamp;
                if (row.timestamp > group.maxTimestamp) group.maxTimestamp = row.timestamp;
            });

            // ê° ê·¸ë£¹ì˜ ë°ì´í„°ë¥¼ íƒ€ì„ìŠ¤íƒ¬í”„ ìˆœìœ¼ë¡œ ì •ë ¬
            Object.values(stimulusGroups).forEach(group => {
                group.data.sort((a, b) => a.timestamp - b.timestamp);
                group.events.sort((a, b) => a.timestamp - b.timestamp);
            });

            renderStimulusList();
        }

        function renderStimulusList() {
            const listElement = document.getElementById('stimulusList');
            
            // ì‹œê°„ìˆœìœ¼ë¡œ ì •ë ¬ (ê°€ì¥ ë¨¼ì € ì‹œì‘ëœ ê²ƒì´ ìœ„ë¡œ)
            const sortedGroups = Object.values(stimulusGroups)
                .sort((a, b) => a.minTimestamp - b.minTimestamp);

            if (sortedGroups.length === 0) {
                listElement.innerHTML = '<div class="loading">ìœ íš¨í•œ Stimulus IDê°€ ì—†ìŠµë‹ˆë‹¤</div>';
                return;
            }

            listElement.innerHTML = sortedGroups.map(group => {
                const onsetEvent = group.events.find(e => e.key.toLowerCase() === 'onset');
                const endEvent = group.events.find(e => 
                    ['timeout', 'end', 'offset'].includes(e.key.toLowerCase())
                );
                
                return `
                    <div class="stimulus-item" onclick="selectStimulus('${group.id}')">
                        <div class="stimulus-id">${group.id}</div>
                        <div class="stimulus-info">
                            ë°ì´í„° í¬ì¸íŠ¸: ${group.data.length}ê°œ<br>
                            ${onsetEvent ? `ì‹œì‘: ${onsetEvent.value || 'onset'}` : ''}<br>
                            ${endEvent ? `ì¢…ë£Œ: ${endEvent.key}` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function selectStimulus(stimulusId) {
            // ì´ì „ ì„ íƒ ì œê±°
            document.querySelectorAll('.stimulus-item').forEach(item => {
                item.classList.remove('active');
            });

            // ìƒˆë¡œìš´ ì„ íƒ í™œì„±í™”
            event.target.closest('.stimulus-item').classList.add('active');

            currentStimulus = stimulusId;
            renderGazePolyline(stimulusId);
            updateStimulusInfo(stimulusId);
            
            // í•´ë‹¹ stimulusì˜ ë°°ê²½ ì´ë¯¸ì§€ê°€ ìˆë‹¤ë©´ í‘œì‹œ
            if (backgroundImages[stimulusId]) {
                setBackgroundImage(stimulusId, backgroundImages[stimulusId]);
            } else {
                clearBackgroundImage();
            }
        }

        function renderGazePolyline(stimulusId) {
            const canvas = document.getElementById('gazeCanvas');
            const ctx = canvas.getContext('2d');
            
            // ìº”ë²„ìŠ¤ ì´ˆê¸°í™”
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            const group = stimulusGroups[stimulusId];
            if (!group || group.data.length === 0) return;

            // ì¢Œí‘œ ë°ì´í„° ì¶”ì¶œ ë° ì •ì œ
            const points = [];
            group.data.forEach(row => {
                let x, y;
                
                // Filtered POR ìš°ì„ , ì—†ìœ¼ë©´ Raw POR ì‚¬ìš©
                if (!isNaN(row.filteredX) && !isNaN(row.filteredY)) {
                    x = row.filteredX;
                    y = row.filteredY;
                } else if (!isNaN(row.rawX) && !isNaN(row.rawY)) {
                    x = row.rawX;
                    y = row.rawY;
                } else {
                    return; // ì¢Œí‘œê°€ ì—†ìœ¼ë©´ ê±´ë„ˆë›°ê¸°
                }

                // í™”ë©´ ë²”ìœ„ ë‚´ì˜ ì¢Œí‘œë§Œ ì‚¬ìš©
                if (x >= 0 && y >= 0 && x <= 1920 && y <= 1080) {
                    points.push({ x, y });
                }
            });

            if (points.length < 2) return;

            // í´ë¦¬ë¼ì¸ ê·¸ë¦¬ê¸°
            ctx.strokeStyle = '#2196F3';
            ctx.lineWidth = 2;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';

            ctx.beginPath();
            ctx.moveTo(points[0].x, points[0].y);
            
            for (let i = 1; i < points.length; i++) {
                ctx.lineTo(points[i].x, points[i].y);
            }
            
            ctx.stroke();

            // ì‹œì‘ì ê³¼ ëì  í‘œì‹œ
            ctx.fillStyle = '#4CAF50';
            ctx.beginPath();
            ctx.arc(points[0].x, points[0].y, 5, 0, 2 * Math.PI);
            ctx.fill();

            ctx.fillStyle = '#f44336';
            ctx.beginPath();
            ctx.arc(points[points.length - 1].x, points[points.length - 1].y, 5, 0, 2 * Math.PI);
            ctx.fill();
        }

        function updateStimulusInfo(stimulusId) {
            const group = stimulusGroups[stimulusId];
            const infoElement = document.getElementById('stimulusInfo');
            
            if (!group) {
                infoElement.innerHTML = '<div class="loading">ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</div>';
                return;
            }

            const onsetEvent = group.events.find(e => e.key.toLowerCase() === 'onset');
            const endEvent = group.events.find(e => 
                ['timeout', 'end', 'offset'].includes(e.key.toLowerCase())
            );

            const duration = (group.maxTimestamp - group.minTimestamp) / 1000000; // ì´ˆ

            infoElement.innerHTML = `
                <div class="info-section">
                    <div class="info-label">Stimulus ID</div>
                    <div class="info-value">${group.id}</div>
                </div>
                
                <div class="info-section">
                    <div class="info-label">ë°ì´í„° í¬ì¸íŠ¸</div>
                    <div class="info-value">${group.data.length}ê°œ</div>
                </div>
                
                <div class="info-section">
                    <div class="info-label">ì§€ì† ì‹œê°„</div>
                    <div class="info-value">${duration.toFixed(2)}ì´ˆ</div>
                </div>
                
                ${onsetEvent ? `
                <div class="info-section">
                    <div class="info-label">ì‹œì‘ ì´ë²¤íŠ¸</div>
                    <div class="info-value">${onsetEvent.value || onsetEvent.key}</div>
                </div>
                ` : ''}
                
                ${endEvent ? `
                <div class="info-section">
                    <div class="info-label">ì¢…ë£Œ ì´ë²¤íŠ¸</div>
                    <div class="info-value">${endEvent.key}${endEvent.value ? ': ' + endEvent.value : ''}</div>
                </div>
                ` : ''}
                
                <div class="info-section">
                    <div class="info-label">ì´ë²¤íŠ¸ ìˆ˜</div>
                    <div class="info-value">${group.events.length}ê°œ</div>
                </div>
            `;
        }

        function setBackgroundImage(stimulusId, imageData) {
            backgroundImages[stimulusId] = imageData;
            
            // ê¸°ì¡´ ë°°ê²½ ì´ë¯¸ì§€ ì œê±°
            clearBackgroundImage();

            // ì´ë¯¸ì§€ ë³€í™˜ ì •ë³´ ì´ˆê¸°í™” (ì²˜ìŒ ì—…ë¡œë“œì‹œ)
            if (!imageTransforms[stimulusId]) {
                imageTransforms[stimulusId] = {
                    x: 0,
                    y: 0,
                    scale: 1
                };
            }

            // ìƒˆ ë°°ê²½ ì´ë¯¸ì§€ ì¶”ê°€
            const img = document.createElement('img');
            img.className = 'background-image';
            img.src = imageData;
            
            const transform = imageTransforms[stimulusId];
            img.style.transform = `translate(-50%, -50%) translate(${transform.x}px, ${transform.y}px) scale(${transform.scale})`;
            
            const imageContainer = document.getElementById('imageContainer');
            imageContainer.appendChild(img);
            
            // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
            img.addEventListener('mousedown', startDrag);
            img.addEventListener('wheel', handleWheel, { passive: false });
            
            // ìŠ¤ì¼€ì¼ ì •ë³´ ì—…ë°ì´íŠ¸
            updateScaleInfo();
        }

        function clearBackgroundImage() {
            const imageContainer = document.getElementById('imageContainer');
            const existing = imageContainer.querySelector('.background-image');
            if (existing) existing.remove();
        }

        function startDrag(e) {
            if (!currentStimulus) return;
            e.preventDefault();
            
            isDragging = true;
            const transform = imageTransforms[currentStimulus];
            dragStart.x = e.clientX - transform.x;
            dragStart.y = e.clientY - transform.y;
            
            document.addEventListener('mousemove', drag);
            document.addEventListener('mouseup', endDrag);
        }

        function drag(e) {
            if (!isDragging || !currentStimulus) return;
            
            const transform = imageTransforms[currentStimulus];
            transform.x = e.clientX - dragStart.x;
            transform.y = e.clientY - dragStart.y;
            
            updateImageTransform();
        }

        function endDrag() {
            isDragging = false;
            document.removeEventListener('mousemove', drag);
            document.removeEventListener('mouseup', endDrag);
        }

        function handleWheel(e) {
            if (!currentStimulus) return;
            e.preventDefault();
            
            const transform = imageTransforms[currentStimulus];
            let scaleFactor;
            
            if (e.ctrlKey) {
                // Ctrl í‚¤ë¥¼ ëˆ„ë¥´ê³  ìˆìœ¼ë©´ 1% ë‹¨ìœ„ë¡œ ì„¸ë°€í•˜ê²Œ ì¡°ì ˆ
                scaleFactor = e.deltaY > 0 ? 0.99 : 1.01;
            } else {
                // ì¼ë°˜ì ì¸ í™•ëŒ€/ì¶•ì†Œ (10% ë‹¨ìœ„)
                scaleFactor = e.deltaY > 0 ? 0.9 : 1.1;
            }
            
            const newScale = Math.max(0.1, Math.min(5, transform.scale * scaleFactor));
            
            transform.scale = newScale;
            updateImageTransform();
        }

        function updateImageTransform() {
            if (!currentStimulus) return;
            
            const img = document.querySelector('.background-image');
            
            if (img) {
                const transform = imageTransforms[currentStimulus];
                img.style.transform = `translate(-50%, -50%) translate(${transform.x}px, ${transform.y}px) scale(${transform.scale})`;
                updateScaleInfo();
            }
        }

        function updateScaleInfo() {
            if (!currentStimulus) return;
            
            const scaleInfo = document.getElementById('scaleInfo');
            const transform = imageTransforms[currentStimulus];
            
            if (scaleInfo && transform) {
                scaleInfo.textContent = `${Math.round(transform.scale * 100)}%`;
            }
        }

        function resetImageTransform() {
            if (!currentStimulus) return;
            
            imageTransforms[currentStimulus] = {
                x: 0,
                y: 0,
                scale: 1
            };
            
            updateImageTransform();
        }

        function removeBackgroundImage() {
            if (!currentStimulus) return;
            
            delete backgroundImages[currentStimulus];
            delete imageTransforms[currentStimulus];
            clearBackgroundImage();
        }

        function showError(message) {
            const statusElement = document.getElementById('uploadStatus');
            statusElement.innerHTML = `<div class="error">${message}</div>`;
        }
    </script>
</body>
</html>
